# 节拍误差统计功能使用说明

## 功能概述

节拍误差统计面板可以帮您分析和比较多个节拍数据集之间的差异，使用**误差容差**机制来处理人工标注时不可避免的误差。

## 功能位置

该功能位于**数据对比页面**（`http://localhost:8082/analysis/compare`）的右侧栏下方。

## 主要功能

### 1. 误差容差设置

您可以选择不同的容差级别来判断两个节拍点是否"匹配"：

- **±20ms（严格）**：适用于要求非常精确的场景
- **±50ms（标准）**：默认选项，适用于大多数情况
- **±100ms（宽松）**：适用于容错要求较高的场景
- **±200ms（非常宽松）**：适用于对时间精度要求不高的场景

**原理**：如果两个节拍点的时间差小于等于容差值，则认为它们是匹配的。这符合实际情况，因为即使是同一个人对同一首音乐进行多次标注，每次标注的时间点也可能略有不同。

### 2. 参考数据集选择

您可以选择任意一个数据集作为**参考基准**，其他数据集将与之进行比较。

例如：
- 选择"专家标注"作为参考基准，可以评估其他标注者与专家的一致性
- 选择"算法检测"作为参考基准，可以评估人工标注与算法的一致性

### 3. 统计指标

系统会为每个数据集计算以下指标：

#### 匹配率
- **定义**：参考数据集中有多少百分比的节拍点在其他数据集中找到了匹配
- **颜色标识**：
  - 🟢 绿色（≥90%）：匹配度很高
  - 🟡 黄色（70-89%）：匹配度中等
  - 🔴 红色（<70%）：匹配度较低

#### 匹配数 / 未匹配数
- 显示具体有多少个节拍点匹配或未匹配

#### 平均误差
- 所有匹配节拍点的平均时间误差（单位：毫秒）
- 数值越小表示标注越精确

### 4. 详细误差分布

展开"详细误差分布"折叠面板，可以看到每个数据集的误差分布情况：

- **0-20ms**：🟢 绿色条 - 非常精确的匹配
- **20-50ms**：🟢 浅绿色条 - 精确的匹配
- **50-100ms**：🟡 橙色条 - 中等精度的匹配
- **>100ms**：🔴 红色条 - 误差较大的匹配

这个分布图可以帮助您了解标注质量的整体情况。

## 使用场景示例

### 场景1：评估多个标注者的一致性

1. 让3个人对同一首音乐进行节拍标注
2. 在对比页面选择其中一个人的标注作为参考基准
3. 设置容差为±50ms（标准）
4. 查看其他两个人的匹配率和平均误差
5. 如果匹配率都在85%以上，说明标注一致性较好

### 场景2：验证算法检测准确性

1. 准备人工标注的"金标准"数据
2. 使用算法进行节拍检测
3. 选择人工标注作为参考基准
4. 设置容差为±100ms（宽松）
5. 查看算法检测的匹配率，评估算法性能

### 场景3：对比不同检测模式

1. 使用不同的检测模式（如"严格模式"和"宽松模式"）检测同一首音乐
2. 选择其中一个模式作为参考基准
3. 查看两种模式的差异程度

## 技术说明

### 匹配算法

系统使用**贪心最近邻匹配算法**：

1. 对于参考数据集中的每个节拍点
2. 在目标数据集中找到时间最接近的节拍点
3. 如果时间差小于等于容差值，则标记为匹配
4. 每个目标节拍点只能匹配一次（避免重复匹配）

### 容差的重要性

**为什么需要容差？**

人类对节拍的感知本身就存在一定的时间窗口。研究表明：
- 人类对节拍时间的感知误差通常在±40-80ms之间
- 即使是专业音乐人，多次标注同一首音乐也会有±30ms左右的误差
- 按键反应时间本身就有约50-150ms的延迟

因此，使用容差是科学合理的，能够更准确地评估标注质量。

## 注意事项

1. **数据集数量**：至少需要2个数据集才能进行统计
2. **自动计算**：页面加载完成后会自动计算一次统计数据
3. **实时更新**：修改容差或参考数据集后，点击"重新计算统计"按钮
4. **数据修改**：如果在页面上编辑了节拍数据，建议重新计算统计

## 快捷操作

- **切换参考基准**：直接在下拉列表中选择，系统会自动重新计算
- **调整容差**：选择不同的容差级别，观察匹配率的变化
- **查看详情**：点击折叠面板查看详细的误差分布图

## 常见问题

**Q：为什么所有数据集的匹配率都很低？**
A：可能是容差设置过小，或者数据集之间确实存在较大差异。尝试增大容差值。

**Q：参考数据集的匹配率为什么是100%？**
A：参考数据集是与自己比较，所以匹配率永远是100%，这是正常的。

**Q：平均误差是0ms是否正常？**
A：如果是参考数据集本身，平均误差为0是正常的。其他情况下为0可能表示数据完全相同。

**Q：如何选择合适的容差？**
A：建议先使用标准容差（±50ms）。如果是评估算法性能，可以使用更大的容差；如果是比较专业标注者，可以使用更小的容差。

---

如有问题或建议，欢迎反馈！

