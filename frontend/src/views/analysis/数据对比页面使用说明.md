# 数据对比页面使用说明

## 功能概述

数据对比页面允许您同时查看和编辑多个节拍数据集，不同数据集用不同颜色进行区分，并提供锁定功能防止误操作。

**重要提示**：本页面的操作方式与单个分析页面（`http://localhost:8082/analysis`）完全一致，采用相同的拖动预览确认机制，便于用户快速上手。

## 主要功能

### 1. 可视化对比
- **多色标记**：每个数据集使用独特的颜色标记，便于区分
- **波形显示**：所有数据集的节拍点叠加显示在同一个音频波形上
- **图例面板**：左侧显示每个数据集的详细信息（创建者、检测模式、节拍数量等）

### 2. 编辑节拍数据

#### 添加节拍点
- **按键添加**：按 `W`/`A`/`S`/`D` 键在当前播放位置添加节拍点
  - 新节拍点会添加到第一个未锁定的数据集
  - 添加后会显示提示消息
  - 建议边听音乐边按键添加节拍点

#### 移动节拍点
- **拖动预览确认机制**（与单个分析页面一致）：
  1. 拖动节拍点标记到新位置
  2. 原标签会变为**灰色**并恢复到原位置
  3. 在新位置会出现**绿色预览标签**，显示"(点击确认)"
  4. 点击绿色预览标签，弹出确认对话框
  5. 确认后才会真正移动节拍点
  6. 绿色预览标签也可以继续拖动调整位置
  
- **取消移动**：
  - 右键点击绿色预览标签，选择"取消移动"
  - 或在确认对话框中点击"取消"

- **键盘移动**（精确调整）：
  1. 右键点击节拍点，选择"键盘移动 (←→)"
  2. 使用 `←` 键向左移动，`→` 键向右移动
  3. 每次移动 0.01 秒
  4. 长按键盘可加速移动
  5. 松开按键后自动记录移动操作
  
- **注意**：
  - 只能拖动未锁定数据集的节拍点
  - 锁定的数据集会阻止拖动操作
  - 键盘移动实时改变节拍点位置，更适合精确调整

#### 删除节拍点
- **右键菜单**：右键点击节拍点，选择"删除"
  - 确认删除后会记录到历史记录
  - 锁定的数据集无法删除节拍点

### 3. 锁定/解锁数据集

#### 锁定功能
- 点击数据集的"锁定"按钮可以锁定该数据集
- 锁定后：
  - ✅ 防止误操作修改数据
  - ✅ 节拍点无法拖动、删除
  - ✅ 无法添加新的节拍点
  - ✅ 保存按钮被禁用
  - ✅ 视觉上显示为灰色

#### 解锁功能
- 点击"已锁定"按钮可以解锁数据集
- 解锁后恢复所有编辑功能

### 4. 保存修改

每个数据集都有独立的保存按钮：
- 点击"保存"按钮保存当前数据集的修改
- 锁定的数据集无法保存
- 保存前会弹出确认对话框
- 保存成功后会更新节拍数量显示

### 5. 撤销操作

支持撤销最近的操作（与单个分析页面一致）：
- 按 `Ctrl+Z` 撤销上一次操作
- **需要确认**：每次撤销操作都会弹出确认对话框，防止误操作
- 支持撤销的操作类型：
  - ✅ 添加节拍点
  - ✅ 移动节拍点
  - ✅ 删除节拍点
- 最多保存 50 条历史记录
- 锁定的数据集相关操作无法撤销

### 6. 播放控制

- **播放/暂停**：控制音频播放
- **缩放调整**：调整波形显示的缩放比例
- **返回按钮**：返回到数据对比选择页面

## 操作流程

### 典型工作流程

1. **选择数据集**
   - 在对比选择页面选择要对比的数据集（至少 2 个）
   - 点击"对比波形"按钮

2. **查看对比**
   - 查看不同颜色的节拍点分布
   - 分析不同数据集之间的差异

3. **锁定参考数据**
   - 将不需要修改的数据集锁定
   - 防止误操作影响参考数据

4. **编辑目标数据**
   - 对未锁定的数据集进行编辑
   - 添加、移动、删除节拍点

5. **保存修改**
   - 点击对应数据集的"保存"按钮
   - 确认保存

## 快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| `W`/`A`/`S`/`D` | 添加节拍点 | 在当前播放位置添加到第一个未锁定的数据集 |
| `拖动` | 创建移动预览 | 原标签变灰，显示绿色预览标签 |
| `左键点击绿色标签` | 确认移动 | 弹出确认对话框 |
| `右键绿色标签` | 取消移动 | 恢复原状态 |
| `右键节拍点` | 显示菜单 | 键盘移动或删除节拍点 |
| `←` / `→` | 移动节拍点 | 需先右键选择，每次0.01s，长按加速 |
| `Ctrl+Z` | 撤销操作 | 弹出确认对话框 |

## 注意事项

1. **锁定保护**
   - 建议先锁定不需要修改的数据集
   - 锁定后的数据集完全无法编辑

2. **保存提醒**
   - 修改后记得及时保存
   - 每个数据集需要单独保存

3. **颜色区分**
   - 不同数据集自动分配不同颜色
   - 最多支持 10 种颜色的自动区分

4. **撤销限制**
   - 只能撤销最近 50 次操作
   - 锁定的数据集无法撤销相关操作

5. **数据一致性**
   - 只能对比同一音乐的不同数据集
   - 所有数据集共享同一个音频文件

## 常见问题

**Q: 按 W/A/S/D 键后没有反应？**
A: 检查是否所有数据集都已锁定。按键添加只对未锁定的数据集有效。确保音乐已经开始播放。

**Q: 拖动节拍点后为什么变灰色了？**
A: 这是正常的预览确认机制。灰色标签保持在原位置，绿色标签显示新位置，点击绿色标签确认移动。

**Q: 如何取消节拍点的移动？**
A: 右键点击绿色预览标签，选择"取消移动"；或在确认对话框中点击"取消"。

**Q: 绿色预览标签可以继续拖动吗？**
A: 可以！绿色预览标签可以继续拖动调整位置，直到您满意后再点击确认。

**Q: 使用←→键无法移动节拍点？**
A: 需要先右键点击节拍点选中它，然后再使用←→键移动。如果仍无法移动，检查该数据集是否已锁定。

**Q: 键盘移动和拖动移动有什么区别？**
A: 
- **拖动移动**：大范围调整位置，需要点击绿色预览标签确认，适合快速调整
- **键盘移动**：每次0.01秒，实时改变位置，不需要确认，适合精确微调

**Q: 无法拖动节拍点？**
A: 检查该节拍点所属的数据集是否已锁定，或者是否有正在进行的移动预览（灰色标签），需要先处理完当前预览。

**Q: 保存按钮是灰色的？**
A: 该数据集已被锁定，需要先解锁才能保存。

**Q: 如何区分不同数据集的节拍点？**
A: 通过颜色区分，图例面板中显示了每个数据集对应的颜色。

**Q: 为什么撤销操作需要确认？**
A: 为了防止误操作，所有撤销操作都需要确认，与单个分析页面保持一致。

**Q: 可以撤销保存操作吗？**
A: 不可以。保存后的修改会永久保存到数据库，建议保存前仔细确认。

## 技术特性

- **拖动预览确认**：与单个分析页面一致的交互体验，灰色原标签+绿色预览标签
- **实时编辑**：所有修改即时反映在界面上
- **历史记录**：自动记录所有编辑操作，支持撤销
- **颜色编码**：自动为数据集分配独特颜色（最多10种）
- **防误操作**：锁定机制+确认对话框，双重保护数据安全
- **独立保存**：每个数据集独立保存，互不影响

## 更新日志

### v1.0.0 (2025-11-06)
- ✅ 与单个分析页面完全一致的操作方式
- ✅ 按 W/A/S/D 键添加节拍点
- ✅ 拖动预览确认机制（灰色原标签+绿色预览标签）
- ✅ 键盘移动功能（←→键，0.01s/次，长按加速）
- ✅ 实现数据集锁定/解锁功能
- ✅ 添加撤销操作支持（Ctrl+Z，需确认）
- ✅ 独立保存每个数据集
- ✅ 优化用户界面和交互体验
- ✅ 添加操作提示和防误操作机制
- ✅ 多色标记区分不同数据集

