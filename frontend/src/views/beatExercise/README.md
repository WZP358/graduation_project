# 节拍练习功能 - 使用真实音频和节拍数据

## 功能概述

基于系统现有音频和节拍数据的节拍练习系统，让用户跟随真实音乐节奏进行打拍练习，通过对比用户击打和标准节拍数据来评估节奏感知能力。

## 核心特性

### 1. 真实音乐练习 🎵
- 使用系统中已有的音频文件
- 加载对应的标准节拍数据作为参考
- 真实音乐环境下的节拍训练

### 2. 双模式练习

#### 跟随模式 (Follow Mode)
- 显示标准节拍点位置提示
- 绿色标记提示即将到来的节拍
- 适合初学者，帮助建立节奏感

#### 盲打模式 (Blind Mode)
- 不显示任何节拍提示
- 完全依靠听觉感知节拍
- 适合进阶训练，锻炼真实节奏感

### 3. 四级难度系统

| 难度 | Perfect容差 | Good容差 | OK容差 | 适用对象 |
|------|-------------|----------|--------|----------|
| 宽松 | ±200ms | ±300ms | ±500ms | 完全新手 |
| 标准 | ±100ms | ±150ms | ±200ms | 初学者 |
| 严格 | ±50ms | ±80ms | ±100ms | 有经验者 |
| 完美 | ±20ms | ±40ms | ±60ms | 专业水平 |

### 4. 实时可视化

```
时间轴视图（当前时间前后2秒）
├─ 当前播放位置线（蓝色中心线）
├─ 标准节拍点（灰色/绿色竖线，跟随模式显示）
└─ 用户击打点（彩色圆点）
    ├─ 🟢 Perfect
    ├─ 🟡 Good
    ├─ ⚪ OK
    └─ 🔴 Miss
```

### 5. 智能评分系统

#### 击打匹配算法
1. 用户按下空格键时记录击打时间
2. 查找最近的未匹配标准节拍点
3. 计算时间误差
4. 根据难度容差判定等级
5. 标记该标准节拍已匹配

#### 评分规则
- **Perfect**: 100分 + Combo加成
- **Good**: 60分 + Combo加成
- **OK**: 30分 + Combo加成
- **Miss**: 0分，连击重置

#### Combo系统
- 连续准确击打增加连击数
- Miss会重置连击
- 连击越高，越有挑战感

### 6. 详细统计分析

#### 实时统计
- 已打节拍数
- 命中数 / 总节拍数
- 实时准确率
- 当前连击

#### 练习后报告
- 准确率（命中数/标准节拍总数）
- 得分
- 击打分布（Perfect/Good/OK/Miss）
- 平均误差
- 最高连击
- 遗漏节拍数
- 误击数（击打在非节拍位置）

#### 误差曲线图
- 显示最近15次击打的误差
- 绿色区域表示容差范围
- 直观看出击打偏早或偏晚的趋势

## 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│ 节拍练习        今日练习: X次  最佳准确率: X%               │
├──────────┬──────────────────────────┬────────────────────────┤
│ 选择音乐  │     游戏区域              │   误差分析             │
│          │                          │                        │
│ - 音乐    │   [音频控制]             │  [误差曲线图]          │
│ - 节拍数据│   [实时统计]             │                        │
│ - 难度    │   [时间轴可视化]         │   练习统计             │
│ - 模式    │   [击打反馈]             │  - 已过节拍            │
│ [开始]   │                          │  - 遗漏数              │
│          │                          │  - 误击数              │
│ [音乐信息]│                          │                        │
│          │                          │   练习技巧             │
│ 最近记录  │                          │  [提示卡片]            │
└──────────┴──────────────────────────┴────────────────────────┘
```

## 使用流程

### 1. 从音乐管理中选择音乐 🎵
```
1. 点击"音乐"下拉框
2. 从音乐管理中已上传的音乐列表中选择
3. 每个音乐会显示其拥有的节拍数据数量
   例如: "夜曲.mp3 (3个节拍数据)"
```

### 2. 系统自动加载对应的节拍数据 📊
```
选择音乐后：
- ✓ 系统会自动查询该音乐对应的所有节拍数据
- ✓ 显示加载状态和加载成功提示
- ✓ 自动选择第一个节拍数据作为默认值
- ⚠️ 如果没有节拍数据，会提示需要先标注
```

### 3. 选择节拍数据作为标准答案 🎯
```
节拍数据选项包括：
- 自动检测（librosa算法）- 绿色标签
- 手动标注（用户标注）- 蓝色标签

显示创建者名称和检测方式，例如：
"张三 (自动检测)"
"李四 (手动标注)"
```

### 4. 设置练习参数 ⚙️
```
难度：选择合适的容差范围
  - 宽松 (±200ms) - 适合完全新手
  - 标准 (±100ms) - 适合初学者
  - 严格 (±50ms) - 适合有经验者
  - 完美 (±20ms) - 适合专业水平

模式：选择练习模式
  - 跟随模式：显示节拍位置提示
  - 盲打模式：不显示提示，纯听觉训练
```

### 5. 开始练习 🎮
```
1. 点击"开始练习"按钮
2. 3秒倒计时准备
3. 音乐自动播放
4. 跟随节奏按空格键或点击屏幕击打
```

### 6. 实时反馈 📊
```
- 每次击打显示判定结果（Perfect/Good/OK/Miss）
- 显示精确误差（±Xms）
- 实时更新统计数据（已打/命中/准确率/连击）
- 误差曲线实时更新
- 时间轴显示标准节拍和用户击打
```

### 7. 查看结果 🏆
```
- 音乐播放完毕自动结束
- 显示详细分析报告
  * 准确率、得分、命中数
  * 击打分布（Perfect/Good/OK/Miss）
  * 平均误差、最高连击
  * 遗漏数、误击数
- 可选择"再练一次"继续训练
- 或"返回"重新选择音乐
```

## 技术实现

### 数据获取
```javascript
// 加载音乐列表
await listMusic({ pageNum: 1, pageSize: 100 })

// 加载指定音乐的节拍数据
await listBeatdata({ musicName: '...', pageNum: 1, pageSize: 100 })

// 获取具体节拍数据
await getBeatdata(beatdataId)
// 返回 beatTimes: "[1.2, 2.4, 3.6, ...]"
```

### 音频播放
```html
<audio ref="audioPlayer" 
    @timeupdate="updateTime" 
    @ended="handleAudioEnd" 
    @loadedmetadata="handleAudioLoaded">
</audio>
```

### 匹配算法
```javascript
function handleHit() {
    const hitTime = currentTime.value;
    
    // 查找最近的未匹配节拍
    let closestBeat = null;
    let minError = Infinity;
    
    standardBeats.value.forEach(beat => {
        if (beat.matched) return;
        const error = Math.abs(beat.time - hitTime);
        if (error < minError) {
            minError = error;
            closestBeat = beat;
        }
    });
    
    // 判定等级
    if (minError <= toleranceConfig.value.ok / 1000) {
        // 在容差范围内
        const errorMs = (hitTime - closestBeat.time) * 1000;
        const absError = Math.abs(errorMs);
        
        if (absError <= toleranceConfig.perfect) result = 'perfect';
        else if (absError <= toleranceConfig.good) result = 'good';
        else result = 'ok';
        
        closestBeat.matched = true;
    } else {
        // 误击
        result = 'miss';
    }
}
```

### 时间轴可视化
```javascript
// 计算节拍在时间轴上的位置（0-100%）
function getBeatPosition(time) {
    const minTime = currentTime.value - 2;  // 显示前2秒
    const maxTime = currentTime.value + 2;  // 显示后2秒
    const range = maxTime - minTime;
    return ((time - minTime) / range) * 100;
}
```

## API接口

### 使用的API
```javascript
// 音乐信息API
import { listMusic } from '@/api/music/music_info';

// 节拍数据API
import { getBeatdata, listBeatdata } from '@/api/music_anaysis/beatdata';
```

### 音频文件URL
```
http://localhost:8080/files/{musicId}
```

## 数据持久化

### LocalStorage
```javascript
{
    // 历史记录
    beatExerciseHistory: [{
        musicName: "歌曲名",
        accuracy: 85,
        hitCount: 42,
        totalBeats: 50,
        avgError: 45,
        timestamp: 1699999999999
    }, ...],
    
    // 今日练习
    beatExerciseToday: "Fri Nov 07 2025",
    beatExerciseTodayCount: "5",
    
    // 最佳记录
    beatExerciseBestAccuracy: "95"
}
```

## 评分标准

### 准确率计算
```
准确率 = (命中节拍数 / 标准节拍总数) × 100%

命中：在容差范围内击打到标准节拍
遗漏：标准节拍过去了但没有击打
误击：击打了但没有匹配到任何标准节拍
```

### 得分计算
```
总得分 = Σ(单次得分)

单次得分:
- Perfect: 100分
- Good: 60分
- OK: 30分
- Miss: 0分
```

## 训练建议

### 初学者
1. 选择 **跟随模式** + **宽松难度**
2. 选择节奏明显的音乐
3. 先熟悉音乐节奏，多听几遍
4. 关注视觉提示，建立节拍感

### 进阶者
1. 尝试 **标准难度** 或 **严格难度**
2. 逐渐减少对视觉提示的依赖
3. 关注误差曲线，调整击打时机
4. 练习不同风格的音乐

### 高手
1. 使用 **盲打模式** + **完美难度**
2. 挑战复杂节奏的音乐
3. 追求 90%+ 准确率
4. 尝试在没有任何提示下完美还原节拍

## 常见问题

### Q: 为什么我的击打总是偏早/偏晚？
A: 查看误差曲线图，如果曲线偏向一侧，说明有系统性偏差。可能是音频延迟或个人习惯。可以有意识地提前或延后击打来补偿。

### Q: 跟随模式和盲打模式的区别？
A: 跟随模式显示标准节拍点位置，帮助学习；盲打模式不显示，完全依靠听觉，更接近真实场景。

### Q: 如何提高准确率？
A: 
1. 多听几遍熟悉音乐
2. 从简单难度开始
3. 关注节奏规律而非单个节拍
4. 放松心态，用身体感受节奏

### Q: 误击是什么？
A: 在没有标准节拍的位置击打，说明节奏感知有偏差。应该只在听到节拍时击打。

## 未来扩展

- [ ] 多人对战模式
- [ ] 排行榜系统
- [ ] 难度自适应（根据表现自动调整）
- [ ] 更多音乐类型分类
- [ ] 练习计划和目标设定
- [ ] 详细的进步曲线分析
- [ ] 导出练习报告

## 相关页面

- **音乐管理**: 添加和管理音频文件
- **节拍数据管理**: 查看和对比节拍数据
- **波形分析**: 标注和编辑节拍点

---

通过这个练习系统，用户可以有效提升音乐节拍感知能力，为音乐创作、表演、DJ等应用打下坚实基础！🎵
